name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.2.0)'
        required: false
        default: ''

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://api.atwoz.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set version tag
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=prod-$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          fi

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew build -x test

      - name: Run tests
        run: ./gradlew test

      - name: Build Docker image
        run: |
          docker build --platform linux/amd64 \
            -t ${{ secrets.DOCKER_USERNAME }}/atwoz:${{ steps.version.outputs.version }} \
            -t ${{ secrets.DOCKER_USERNAME }}/atwoz:prod-latest .

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Push Docker images
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/atwoz:${{ steps.version.outputs.version }}
          docker push ${{ secrets.DOCKER_USERNAME }}/atwoz:prod-latest

      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_EC2_HOST }}
          username: ${{ secrets.PROD_EC2_USERNAME }}
          key: ${{ secrets.PROD_SSH_PEM_KEY }}
          script: |
            # ÌôòÍ≤Ω Î≥ÄÏàò ÏóÖÎç∞Ïù¥Ìä∏
            echo "${{ secrets.PROD_ENV }}" > /home/${{ secrets.PROD_EC2_USERNAME }}/.env

            # Î∞∞Ìè¨ Ï†Ñ Î∞±ÏóÖ
            if docker ps -q -f name=spring-app > /dev/null 2>&1; then
              docker commit spring-app spring-app-backup
              echo "Created backup image: spring-app-backup"
            fi

            # Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏ Ïã§Ìñâ
            sudo /home/${{ secrets.PROD_EC2_USERNAME }}/deploy_script.sh

      - name: Run smoke tests
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_EC2_HOST }}
          username: ${{ secrets.PROD_EC2_USERNAME }}
          key: ${{ secrets.PROD_SSH_PEM_KEY }}
          script: |
            # Ìó¨Ïä§ Ï≤¥ÌÅ¨ (ÏµúÎåÄ 3Î∂Ñ ÎåÄÍ∏∞)
            for i in {1..18}; do
              if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
                echo "‚úì Health check passed"
                exit 0
              fi
              echo "Waiting for application to start... ($i/18)"
              sleep 10
            done
            echo "‚úó Health check failed"
            exit 1

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_EC2_HOST }}
          username: ${{ secrets.PROD_EC2_USERNAME }}
          key: ${{ secrets.PROD_SSH_PEM_KEY }}
          script: |
            # Ï£ºÏöî ÏóîÎìúÌè¨Ïù∏Ìä∏ ÌôïÏù∏
            echo "Checking main endpoints..."

            # Ïª®ÌÖåÏù¥ÎÑà ÏÉÅÌÉú ÌôïÏù∏
            if ! docker ps | grep -q spring-app; then
              echo "‚úó Container is not running"
              exit 1
            fi

            echo "‚úì Container is running"

            # Î°úÍ∑∏ÏóêÏÑú ÏóêÎü¨ ÌôïÏù∏
            ERROR_COUNT=$(docker logs spring-app 2>&1 | grep -i "ERROR" | wc -l)
            echo "Error count in logs: $ERROR_COUNT"

            if [ $ERROR_COUNT -gt 10 ]; then
              echo "‚úó Too many errors in logs"
              exit 1
            fi

            echo "‚úì Deployment verification successful"

      - name: Notify deployment success
        if: success()
        run: |
          echo "üöÄ Production deployment successful!"
          echo "Version: ${{ steps.version.outputs.version }}"
          echo "URL: https://api.atwoz.com"
          echo "Deployed at: $(date)"

      - name: Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_EC2_HOST }}
          username: ${{ secrets.PROD_EC2_USERNAME }}
          key: ${{ secrets.PROD_SSH_PEM_KEY }}
          script: |
            echo "Deployment failed. Rolling back..."

            # ÌòÑÏû¨ Ïª®ÌÖåÏù¥ÎÑà Ï§ëÏßÄ
            docker stop spring-app || true
            docker rm spring-app || true

            # Î∞±ÏóÖ Ïù¥ÎØ∏ÏßÄÎ°ú Î≥µÏõê
            if docker images | grep -q spring-app-backup; then
              docker run -d \
                --name spring-app \
                --env-file /home/${{ secrets.PROD_EC2_USERNAME }}/.env \
                -p 8080:8080 \
                -v /home/${{ secrets.PROD_EC2_USERNAME }}/secrets:/etc/credentials:ro \
                -v /home/${{ secrets.PROD_EC2_USERNAME }}/certs:/etc/certs:ro \
                --restart unless-stopped \
                spring-app-backup

              echo "Rolled back to previous version"
            else
              echo "No backup found. Manual intervention required!"
            fi

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "‚ùå Production deployment failed and rolled back!"
          echo "Please check logs and investigate."
          exit 1