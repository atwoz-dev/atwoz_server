name: CD - Development

on:
  push:
    branches: [ "develop" ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
      - '.env.example'

concurrency:
  group: deploy-dev
  cancel-in-progress: false

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: deepple

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: development
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          mask-aws-account-id: true

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}
          tags: |
            type=raw,value=dev-latest
            type=sha,prefix=dev-

      - name: Build and push Docker image
        id: build-image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to EC2 via SSM
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: dev-latest
          CONTAINER_NAME: deepple-app
          BLUE_PORT: 8081
          GREEN_PORT: 8082
          HEALTH_CHECK_MAX_RETRIES: 50
          HEALTH_CHECK_INTERVAL: 2
        run: |
          echo "Preparing deployment script..."

          # Encode .env content to base64
          ENV_CONTENT_B64=$(echo "${{ secrets.DEV_ENV }}" | base64 | tr -d '\n')

          # Prepare deployment script with environment variables
          export ENV_CONTENT_B64
          export AWS_REGION="${{ env.AWS_REGION }}"
          export ECR_REGISTRY="${{ env.ECR_REGISTRY }}"
          export ECR_REPOSITORY="${{ env.ECR_REPOSITORY }}"
          export IMAGE_TAG="${{ env.IMAGE_TAG }}"
          export CONTAINER_NAME="${{ env.CONTAINER_NAME }}"
          export BLUE_PORT="${{ env.BLUE_PORT }}"
          export GREEN_PORT="${{ env.GREEN_PORT }}"
          export HEALTH_CHECK_MAX_RETRIES="${{ env.HEALTH_CHECK_MAX_RETRIES }}"
          export HEALTH_CHECK_INTERVAL="${{ env.HEALTH_CHECK_INTERVAL }}"

          # Substitute variables in deploy script
          envsubst < .github/scripts/deploy-dev.sh > /tmp/deploy-rendered.sh
          chmod +x /tmp/deploy-rendered.sh

          echo "Uploading deployment script to EC2 via SSM..."

          # Upload script to EC2
          SCRIPT_CONTENT=$(cat /tmp/deploy-rendered.sh | base64 | tr -d '\n')

          UPLOAD_CMD_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.DEV_EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --timeout-seconds 60 \
            --parameters commands="[\"echo ${SCRIPT_CONTENT} | base64 -d > /tmp/deploy.sh\",\"chmod +x /tmp/deploy.sh\"]" \
            --output text \
            --query "Command.CommandId")

          echo "Upload command ID: $UPLOAD_CMD_ID"

          # Wait for upload to complete
          aws ssm wait command-executed \
            --command-id $UPLOAD_CMD_ID \
            --instance-id "${{ secrets.DEV_EC2_INSTANCE_ID }}"

          UPLOAD_STATUS=$(aws ssm get-command-invocation \
            --command-id $UPLOAD_CMD_ID \
            --instance-id "${{ secrets.DEV_EC2_INSTANCE_ID }}" \
            --query 'Status' \
            --output text)

          if [ "$UPLOAD_STATUS" != "Success" ]; then
            echo "Failed to upload deployment script"
            exit 1
          fi

          echo "Script uploaded successfully. Executing deployment..."

          # Execute deployment script
          DEPLOY_CMD_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.DEV_EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --timeout-seconds 600 \
            --parameters commands='["bash /tmp/deploy.sh"]' \
            --output text \
            --query "Command.CommandId")

          echo "Deployment command ID: $DEPLOY_CMD_ID"
          echo "Waiting for deployment to complete..."

          # Wait for deployment to complete
          aws ssm wait command-executed \
            --command-id $DEPLOY_CMD_ID \
            --instance-id "${{ secrets.DEV_EC2_INSTANCE_ID }}"

          # Get deployment output
          echo ""
          echo "=========================================="
          echo "Deployment Output:"
          echo "=========================================="
          aws ssm get-command-invocation \
            --command-id $DEPLOY_CMD_ID \
            --instance-id "${{ secrets.DEV_EC2_INSTANCE_ID }}" \
            --query 'StandardOutputContent' \
            --output text

          # Check deployment status
          DEPLOY_STATUS=$(aws ssm get-command-invocation \
            --command-id $DEPLOY_CMD_ID \
            --instance-id "${{ secrets.DEV_EC2_INSTANCE_ID }}" \
            --query 'Status' \
            --output text)

          if [ "$DEPLOY_STATUS" != "Success" ]; then
            echo ""
            echo "=========================================="
            echo "Deployment Error Output:"
            echo "=========================================="
            aws ssm get-command-invocation \
              --command-id $DEPLOY_CMD_ID \
              --instance-id "${{ secrets.DEV_EC2_INSTANCE_ID }}" \
              --query 'StandardErrorContent' \
              --output text
            exit 1
          fi

          echo ""
          echo "=========================================="
          echo "Deployment Completed Successfully!"
          echo "=========================================="
