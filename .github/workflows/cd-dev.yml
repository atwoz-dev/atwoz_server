name: CD - Development

on:
  push:
    branches: [ "develop" ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
      - '.env.example'

concurrency:
  group: deploy-dev
  cancel-in-progress: false

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: deepple
  CONTAINER_NAME: deepple-app
  BLUE_PORT: "8081"
  GREEN_PORT: "8082"
  HEALTH_CHECK_MAX_RETRIES: "100"
  HEALTH_CHECK_INTERVAL: "3"

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: development
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          mask-aws-account-id: true

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:dev-${{ github.sha }}
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:dev-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to EC2 via SSM
        run: |
          # 배포 스크립트 base64 인코딩
          DEPLOY_SCRIPT_B64=$(base64 -w 0 .github/scripts/deploy-dev.sh)
          
          # 환경변수 파일 base64 인코딩
          ENV_CONTENT_B64=$(echo -n '${{ secrets.ENV }}' | base64 -w 0)
          
          # SSM 명령 실행
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.DEV_EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --timeout-seconds 600 \
            --parameters commands="[
              \"echo ${DEPLOY_SCRIPT_B64} | base64 -d > /tmp/deploy.sh\",
              \"chmod +x /tmp/deploy.sh\",
              \"/tmp/deploy.sh '${ENV_CONTENT_B64}' '${{ env.AWS_REGION }}' '${{ steps.login-ecr.outputs.registry }}' '${{ env.ECR_REPOSITORY }}' 'dev-${{ github.sha }}' '${{ env.CONTAINER_NAME }}' '${{ env.BLUE_PORT }}' '${{ env.GREEN_PORT }}' '${{ env.HEALTH_CHECK_MAX_RETRIES }}' '${{ env.HEALTH_CHECK_INTERVAL }}'\"
            ]" \
            --query "Command.CommandId" \
            --output text)
          
          echo "Command ID: $COMMAND_ID"
          echo "Waiting for deployment..."
          
          # 결과 폴링
          for i in {1..120}; do
            sleep 5
          
            RESULT=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ secrets.DEV_EC2_INSTANCE_ID }}" 2>/dev/null) || continue
          
            STATUS=$(echo "$RESULT" | jq -r '.Status')
          
            case "$STATUS" in
              Success)
                echo ""
                echo "===== Deployment Output ====="
                echo "$RESULT" | jq -r '.StandardOutputContent // empty'
                echo ""
                echo "Deployment completed successfully!"
                exit 0
                ;;
              Failed|TimedOut|Cancelled)
                echo ""
                echo "===== Deployment Output ====="
                echo "$RESULT" | jq -r '.StandardOutputContent // empty'
                echo ""
                echo "===== Error Output ====="
                echo "$RESULT" | jq -r '.StandardErrorContent // empty'
                echo ""
                echo "Deployment failed with status: $STATUS"
                exit 1
                ;;
              *)
                if [ $((i % 6)) -eq 0 ]; then
                  echo "Status: $STATUS... ($((i * 5))s elapsed)"
                fi
                ;;
            esac
          done
          
          echo "Timeout waiting for deployment result"
          exit 1
